<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD ‚Üí HTML Converter</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        :root {
            --bg: #f5f5f5; --editor-bg: #fff; --text: #333; --border: #ddd;
            --accent: #0073bb; --success: #067d17; --code-bg: #f4f4f4;
        }
        .dark {
            --bg: #1a1a2e; --editor-bg: #16213e; --text: #eee; --border: #333;
            --accent: #4da6ff; --success: #4ade80; --code-bg: #0f0f23;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg); color: var(--text); min-height: 100vh;
        }
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; background: var(--editor-bg); border-bottom: 1px solid var(--border);
            flex-wrap: wrap; gap: 8px;
        }
        h1 { font-size: 1.2rem; }
        .controls { display: flex; gap: 6px; flex-wrap: wrap; }
        button {
            padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px;
            background: var(--editor-bg); color: var(--text); cursor: pointer;
            font-size: 0.85rem; transition: all 0.2s; white-space: nowrap;
        }
        button:hover { border-color: var(--accent); color: var(--accent); }
        button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
        button.primary:hover { opacity: 0.9; color: #fff; }
        button.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--success); color: #fff; padding: 12px 24px;
            border-radius: 8px; opacity: 0; transition: opacity 0.3s; z-index: 100;
        }
        .toast.show { opacity: 1; }
        main { display: flex; height: calc(100vh - 57px); }
        .pane {
            flex: 1; display: flex; flex-direction: column;
            min-width: 200px; overflow: hidden;
        }
        .pane:first-child { border-right: 1px solid var(--border); }
        .resizer {
            width: 6px; background: var(--border); cursor: col-resize;
            transition: background 0.2s; flex-shrink: 0;
        }
        .resizer:hover, .resizer.dragging { background: var(--accent); }
        .pane-header {
            padding: 8px 16px; background: var(--editor-bg);
            border-bottom: 1px solid var(--border); font-weight: 500; font-size: 0.85rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        #editor {
            flex: 1; width: 100%; padding: 16px; border: none; resize: none;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 14px; line-height: 1.6; background: var(--editor-bg);
            color: var(--text); outline: none;
        }
        #preview {
            flex: 1; padding: 20px 24px; overflow-y: auto;
            background: var(--editor-bg); color: var(--text);
        }
        #preview h1 { font-size: 1.8em; margin: 0.5em 0; border-bottom: 1px solid var(--border); padding-bottom: 0.3em; }
        #preview h2 { font-size: 1.5em; margin: 0.8em 0 0.4em; }
        #preview h3 { font-size: 1.25em; margin: 0.8em 0 0.4em; }
        #preview p { margin: 0.8em 0; line-height: 1.6; }
        #preview ul, #preview ol { margin: 0.8em 0; padding-left: 2em; }
        #preview li { margin: 0.3em 0; line-height: 1.6; }
        #preview code {
            background: var(--code-bg); padding: 2px 6px; border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace; font-size: 0.9em;
        }
        #preview pre {
            background: var(--code-bg); padding: 16px; border-radius: 8px;
            overflow-x: auto; margin: 1em 0;
        }
        #preview pre code { background: none; padding: 0; }
        #preview blockquote {
            border-left: 4px solid var(--accent); margin: 1em 0;
            padding: 0.5em 1em; background: var(--code-bg); color: var(--text); opacity: 0.9;
        }
        #preview table { border-collapse: collapse; width: 100%; margin: 1em 0; }
        #preview th, #preview td {
            border: 1px solid var(--border); padding: 10px 12px; text-align: left;
        }
        #preview th { background: var(--code-bg); font-weight: 600; }
        #preview a { color: var(--accent); }
        #preview img { max-width: 100%; height: auto; }
        #preview hr { border: none; border-top: 1px solid var(--border); margin: 1.5em 0; }
        #preview .mermaid-container { margin: 1em 0; background: #fff; padding: 16px; border-radius: 8px; text-align: center; }
        #preview .mermaid-container svg { max-width: 100%; height: auto; display: inline-block; }
        #preview .mermaid-error { color: #c00; background: #fee; padding: 8px; border-radius: 4px; font-size: 0.85em; }
        .drop-zone {
            position: absolute; inset: 0; background: rgba(0,115,187,0.1);
            border: 3px dashed var(--accent); display: none;
            align-items: center; justify-content: center; font-size: 1.2rem;
            color: var(--accent); z-index: 50;
        }
        .drop-zone.active { display: flex; }
        .file-input { display: none; }
    </style>
</head>
<body>
    <header>
        <h1>üìù MD ‚Üí HTML</h1>
        <div class="controls">
            <button onclick="document.getElementById('fileInput').click()">üìÅ Open</button>
            <button onclick="downloadHTML()">üíæ HTML</button>
            <button onclick="copyForWord()">üìÑ Word</button>
            <button id="excelBtn" onclick="exportExcel()" style="display:none">üìä Excel</button>
            <button onclick="copyRaw()">üî§ Code</button>
            <button onclick="copyRich()" class="primary">üìã Copy</button>
            <button onclick="toggleTheme()">üåì</button>
        </div>
    </header>
    <main>
        <div class="pane" id="editorPane" style="position: relative;">
            <div class="pane-header">
                <span>Markdown</span>
            </div>
            <textarea id="editor" placeholder="Paste or type your markdown here...

Supports:
‚Ä¢ Headers, bold, italic
‚Ä¢ Lists (ordered & unordered)
‚Ä¢ Code blocks
‚Ä¢ Tables
‚Ä¢ Blockquotes
‚Ä¢ Mermaid diagrams

Drag & drop .md files to load them."></textarea>
            <div class="drop-zone" id="dropZone">Drop .md file here</div>
        </div>
        <div class="resizer" id="resizer"></div>
        <div class="pane" id="previewPane">
            <div class="pane-header">Preview</div>
            <div id="preview" contenteditable="true"></div>
        </div>
    </main>
    <input type="file" id="fileInput" class="file-input" accept=".md,.markdown,.txt">
    <div class="toast" id="toast">Copied!</div>

    <script>
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const toast = document.getElementById('toast');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const resizer = document.getElementById('resizer');
        const editorPane = document.getElementById('editorPane');
        const previewPane = document.getElementById('previewPane');

        mermaid.initialize({ startOnLoad: false, theme: 'default', securityLevel: 'loose' });

        // Custom renderer for mermaid
        const renderer = new marked.Renderer();
        let mermaidId = 0;
        renderer.code = function({ text, lang }) {
            if (lang === 'mermaid') {
                const id = `mermaid-${mermaidId++}`;
                return `<div class="mermaid-container"><pre class="mermaid" id="${id}">${text}</pre></div>`;
            }
            const escaped = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return `<pre><code class="language-${lang || ''}">${escaped}</code></pre>`;
        };
        marked.setOptions({ breaks: true, gfm: true, renderer });

        let renderTimeout;
        async function render() {
            mermaidId = 0;
            const html = DOMPurify.sanitize(marked.parse(editor.value), {
                ALLOWED_TAGS: ['h1','h2','h3','h4','h5','h6','p','br','hr','ul','ol','li','blockquote','pre','code','table','thead','tbody','tr','th','td','a','img','strong','b','em','i','u','s','del','sub','sup','span','div'],
                ALLOWED_ATTR: ['href','src','alt','title','class','id']
            });
            preview.innerHTML = html || '<p style="color:#999">Preview will appear here...</p>';
            
            // Show Excel button only if tables exist
            document.getElementById('excelBtn').style.display = 
                preview.querySelector('table') ? 'inline-block' : 'none';
            
            // Render mermaid diagrams with better error handling
            const mermaidNodes = preview.querySelectorAll('.mermaid');
            for (const node of mermaidNodes) {
                const code = node.textContent.trim();
                const container = node.parentElement;
                try {
                    const { svg } = await mermaid.render(node.id + '-svg', code);
                    container.innerHTML = svg;
                } catch(e) {
                    container.innerHTML = `<div class="mermaid-error">‚ö†Ô∏è Mermaid error: ${e.message || 'Invalid diagram syntax'}</div><pre style="text-align:left;font-size:0.8em;margin-top:8px">${code}</pre>`;
                }
            }
        }

        editor.addEventListener('input', () => {
            clearTimeout(renderTimeout);
            renderTimeout = setTimeout(render, 150);
        });

        // Bi-directional: HTML to Markdown conversion
        function htmlToMarkdown(element) {
            let md = '';
            const walk = (node, listDepth = 0, listType = null) => {
                if (node.nodeType === 3) { // text node
                    md += node.textContent;
                    return;
                }
                if (node.nodeType !== 1) return;
                
                const tag = node.tagName.toLowerCase();
                const children = () => [...node.childNodes].forEach(c => walk(c, listDepth, listType));
                
                switch(tag) {
                    case 'h1': md += '# '; children(); md += '\n\n'; break;
                    case 'h2': md += '## '; children(); md += '\n\n'; break;
                    case 'h3': md += '### '; children(); md += '\n\n'; break;
                    case 'h4': md += '#### '; children(); md += '\n\n'; break;
                    case 'h5': md += '##### '; children(); md += '\n\n'; break;
                    case 'h6': md += '###### '; children(); md += '\n\n'; break;
                    case 'p': children(); md += '\n\n'; break;
                    case 'br': md += '\n'; break;
                    case 'hr': md += '\n---\n\n'; break;
                    case 'strong': case 'b': md += '**'; children(); md += '**'; break;
                    case 'em': case 'i': md += '*'; children(); md += '*'; break;
                    case 'code':
                        if (node.parentElement?.tagName.toLowerCase() === 'pre') children();
                        else { md += '`'; children(); md += '`'; }
                        break;
                    case 'pre':
                        const codeEl = node.querySelector('code');
                        const lang = codeEl?.className.replace('language-', '') || '';
                        md += '```' + lang + '\n' + (codeEl?.textContent || node.textContent) + '\n```\n\n';
                        break;
                    case 'blockquote':
                        const lines = [];
                        [...node.childNodes].forEach(c => {
                            let tmp = '';
                            const getText = (n) => {
                                if (n.nodeType === 3) tmp += n.textContent;
                                else if (n.nodeType === 1) [...n.childNodes].forEach(getText);
                            };
                            getText(c);
                            if (tmp.trim()) lines.push(tmp.trim());
                        });
                        md += lines.map(l => '> ' + l).join('\n') + '\n\n';
                        break;
                    case 'ul': [...node.children].forEach(c => walk(c, listDepth, 'ul')); md += listDepth === 0 ? '\n' : ''; break;
                    case 'ol': [...node.children].forEach(c => walk(c, listDepth, 'ol')); md += listDepth === 0 ? '\n' : ''; break;
                    case 'li':
                        const indent = '  '.repeat(listDepth);
                        const bullet = listType === 'ol' ? '1. ' : '- ';
                        md += indent + bullet;
                        [...node.childNodes].forEach(c => {
                            if (c.tagName === 'UL' || c.tagName === 'OL') walk(c, listDepth + 1, c.tagName.toLowerCase());
                            else walk(c, listDepth, listType);
                        });
                        md += '\n';
                        break;
                    case 'a':
                        md += '['; children(); md += '](' + (node.href || '') + ')';
                        break;
                    case 'img':
                        md += '![' + (node.alt || '') + '](' + (node.src || '') + ')';
                        break;
                    case 'table':
                        const rows = [...node.querySelectorAll('tr')];
                        rows.forEach((row, i) => {
                            const cells = [...row.querySelectorAll('th, td')];
                            md += '| ' + cells.map(c => c.textContent.trim()).join(' | ') + ' |\n';
                            if (i === 0 && row.querySelector('th')) {
                                md += '| ' + cells.map(() => '---').join(' | ') + ' |\n';
                            }
                        });
                        md += '\n';
                        break;
                    case 'div':
                        if (node.classList.contains('mermaid-container')) {
                            const mermaidPre = node.querySelector('.mermaid');
                            if (mermaidPre) md += '```mermaid\n' + mermaidPre.textContent + '\n```\n\n';
                        } else children();
                        break;
                    default: children();
                }
            };
            [...element.childNodes].forEach(c => walk(c));
            return md.replace(/\n{3,}/g, '\n\n').trim();
        }

        let syncTimeout;
        preview.addEventListener('input', () => {
            clearTimeout(syncTimeout);
            syncTimeout = setTimeout(() => {
                editor.value = htmlToMarkdown(preview);
            }, 500);
        });

        // Resizable panes
        let isResizing = false;
        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizer.classList.add('dragging');
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        });
        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const container = document.querySelector('main');
            const containerRect = container.getBoundingClientRect();
            const percent = ((e.clientX - containerRect.left) / containerRect.width) * 100;
            const clamped = Math.min(Math.max(percent, 20), 80);
            editorPane.style.flex = `0 0 ${clamped}%`;
            previewPane.style.flex = `0 0 ${100 - clamped - 1}%`;
        });
        document.addEventListener('mouseup', () => {
            isResizing = false;
            resizer.classList.remove('dragging');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        });

        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function copyRich() {
            const range = document.createRange();
            range.selectNodeContents(preview);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
            document.execCommand('copy');
            sel.removeAllRanges();
            showToast('‚úì Copied for Docs');
        }

        function copyRaw() {
            navigator.clipboard.writeText(preview.innerHTML);
            showToast('‚úì HTML copied');
        }

        // Copy with inline styles for Word/Excel
        function copyForWord() {
            const clone = preview.cloneNode(true);
            
            // Add inline styles for Word compatibility
            clone.querySelectorAll('table').forEach(t => {
                t.setAttribute('style', 'border-collapse:collapse;width:100%;font-family:Calibri,Arial,sans-serif;');
            });
            clone.querySelectorAll('th').forEach(th => {
                th.setAttribute('style', 'border:1px solid #000;padding:8px 12px;background-color:#f0f0f0;font-weight:bold;text-align:left;');
            });
            clone.querySelectorAll('td').forEach(td => {
                td.setAttribute('style', 'border:1px solid #000;padding:8px 12px;text-align:left;');
            });
            clone.querySelectorAll('h1,h2,h3,h4,h5,h6').forEach(h => {
                const sizes = {H1:'24pt',H2:'18pt',H3:'14pt',H4:'12pt',H5:'11pt',H6:'10pt'};
                h.setAttribute('style', `font-size:${sizes[h.tagName]};font-weight:bold;margin:12px 0;font-family:Calibri,Arial,sans-serif;`);
            });
            clone.querySelectorAll('p,li').forEach(p => {
                p.setAttribute('style', 'font-family:Calibri,Arial,sans-serif;font-size:11pt;line-height:1.5;margin:6px 0;');
            });
            clone.querySelectorAll('code').forEach(c => {
                c.setAttribute('style', 'font-family:Consolas,Monaco,monospace;background-color:#f4f4f4;padding:2px 4px;');
            });
            clone.querySelectorAll('pre').forEach(pre => {
                pre.setAttribute('style', 'font-family:Consolas,Monaco,monospace;background-color:#f4f4f4;padding:12px;margin:8px 0;white-space:pre-wrap;');
            });

            const html = clone.innerHTML;
            const blob = new Blob([html], { type: 'text/html' });
            navigator.clipboard.write([
                new ClipboardItem({
                    'text/html': blob,
                    'text/plain': new Blob([preview.innerText], { type: 'text/plain' })
                })
            ]).then(() => showToast('‚úì Copied for Word'));
        }

        function exportExcel() {
            const tables = preview.querySelectorAll('table');
            if (!tables.length) return;
            
            let html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="UTF-8"></head><body>';
            tables.forEach(t => {
                const clone = t.cloneNode(true);
                clone.setAttribute('border', '1');
                clone.querySelectorAll('th,td').forEach(cell => {
                    cell.setAttribute('style', 'border:1px solid #000;padding:8px;');
                });
                html += clone.outerHTML + '<br>';
            });
            html += '</body></html>';
            
            const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'table.xls';
            a.click();
            showToast('‚úì Excel file downloaded');
        }

        function downloadHTML() {
            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>
                body{font-family:-apple-system,sans-serif;max-width:800px;margin:40px auto;padding:20px;line-height:1.6}
                code{background:#f4f4f4;padding:2px 6px;border-radius:4px}
                pre{background:#f4f4f4;padding:16px;border-radius:8px;overflow-x:auto}
                blockquote{border-left:4px solid #0073bb;margin:1em 0;padding:0.5em 1em;background:#f9f9f9}
                table{border-collapse:collapse;width:100%}th,td{border:1px solid #000;padding:10px}
                th{background:#f5f5f5}
            </style></head><body>${preview.innerHTML}</body></html>`;
            const blob = new Blob([html], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'document.html';
            a.click();
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
        }

        // Drag & drop
        ['dragenter', 'dragover'].forEach(e => {
            document.addEventListener(e, (ev) => { ev.preventDefault(); dropZone.classList.add('active'); });
        });
        ['dragleave', 'drop'].forEach(e => {
            document.addEventListener(e, () => dropZone.classList.remove('active'));
        });
        document.addEventListener('drop', (e) => {
            e.preventDefault();
            if (e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) loadFile(e.target.files[0]);
        });

        function loadFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => { editor.value = e.target.result; render(); showToast('‚úì File loaded'); };
            reader.readAsText(file);
        }

        render();
    </script>
</body>
</html>
